<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>币种跌幅榜</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-size: 14px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 28px;
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .right-header-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .time-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
      font-size: 13px;
      color: #7f8c8d;
    }

    .update-time-row {
      margin-bottom: 4px;
    }

    .refresh-button {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .refresh-button:hover {
      background: linear-gradient(135deg, #2980b9, #3498db);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .refresh-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .countdown {
      font-weight: bold;
      color: #e74c3c;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px 0;
      border-bottom: 1px solid #ecf0f1;
    }

    .config-button {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .config-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      background: linear-gradient(135deg, #45a049, #4caf50);
    }

    .config-button:active {
      transform: translateY(0);
    }

    .info-note {
      background-color: #e3f2fd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 14px;
      color: #2c3e50;
      border-left: 4px solid #2196f3;
    }

    .net-inflow-card {
      margin-top: 10px;
      margin-bottom: 16px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 14px 16px;
    }

    .net-inflow-title {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #2c3e50;
      font-weight: 600;
    }

    .net-inflow-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px 14px;
    }

    .net-inflow-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 6px;
      background: #f9fafb;
    }

    .net-inflow-item .symbol {
      font-weight: 600;
      color: #1f2937;
    }

    .net-inflow-item .value {
      font-weight: 600;
    }

    .net-inflow-item .value.positive {
      color: #27ae60;
    }

    .net-inflow-item .value.negative {
      color: #e74c3c;
    }

    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      border-left: 4px solid #f44336;
    }

    .no-data {
      text-align: center;
      color: #95a5a6;
      font-style: italic;
      padding: 25px;
      font-size: 16px;
    }

    /* ==================== 表格容器 ==================== */
    .table-wrapper {
      margin-top: 25px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      background: white;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background-color: transparent;
      /* 强制创建合成层，启用GPU加速 */
      transform: translateZ(0);
      will-change: contents;
    }

    /* ==================== 表头设计 ==================== */
    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    th {
      padding: 16px 14px;
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #ffffff;
      border: none;
      white-space: nowrap;
    }

    th:first-child {
      text-align: left;
      padding-left: 20px;
    }

    /* ==================== 单元格设计 ==================== */
    td {
      padding: 14px;
      text-align: center;
      font-size: 14px;
      font-weight: 400;
      color: #4b5563;
      border-bottom: 1px solid #f3f4f6;
    }

    /* 币种名称列（带 rowspan） */
    td[rowspan] {
      text-align: left;
      padding-left: 20px;
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
      vertical-align: middle;
      border-right: 2px solid #e5e7eb;
    }

    /* 类型列（持仓量/持仓价值/价格） */
    /* 第一行的类型列（在币种名称之后） */
    tbody tr td:nth-child(2):not([rowspan]),
    /* 第二、三行的类型列（第一列，因为币种跨行） */
    tbody tr td:first-child:not([rowspan]) {
      text-align: center;
      font-weight: 400;
      color: #6b7280;
      font-size: 14px;
      min-width: 80px;
    }

    /* 当前值列 */
    /* 第一行的当前值（第3列） */
    tbody tr td:nth-child(3),
    /* 第二、三行的当前值（第2列） */
    tbody tr td:nth-child(2):not(:first-child):not([rowspan]) {
      text-align: center;
      font-weight: 400;
      color: #1f2937;
      font-size: 14px;
    }

    /* ==================== 表格行设计 ==================== */
    tbody tr {
      background-color: white;
      /* 强制启用硬件加速，消除闪烁 */
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }

    /* 斑马纹 */
    tbody tr:nth-child(6n+2),
    tbody tr:nth-child(6n+3),
    tbody tr:nth-child(6n+4) {
      background-color: white;
    }

    tbody tr:nth-child(6n+5),
    tbody tr:nth-child(6n+6),
    tbody tr:nth-child(6n+1):not(:first-child) {
      background-color: #f9fafb;
    }

    /* ==================== 悬停效果（零抖动、零闪烁） ==================== */
    tbody tr:hover {
      background-color: #eef2ff !important;
    }

    tbody tr:hover td {
      color: #1f2937;
    }

    tbody tr:hover td[rowspan] {
      color: #667eea;
    }

    /* 币种组分隔 */
    tr.coin-group-last td {
      border-bottom: 3px solid #e5e7eb;
    }

    /* 最后一行处理 */
    tbody tr:last-child td {
      border-bottom: none;
    }

    .positive {
      color: #27ae60;
      font-weight: 600;
    }

    .negative {
      color: #e74c3c;
      font-weight: 600;
    }

    .current-interest {
      font-weight: bold;
    }

    .change-cell {
      font-size: 13px;
      line-height: 1.3;
    }

    .change-row {
      margin-bottom: 3px;
    }

    .change-row:last-child {
      margin-bottom: 0;
    }

    .change-value {
      font-weight: 600;
    }

    .change-percent {
      display: inline-block;
      margin-right: 5px;
    }

    .change-amount {
      font-size: 12px;
      color: #7f8c8d;
    }

    .last-update {
      text-align: right;
      font-size: 13px;
      color: #7f8c8d;
    }

    .update-info {
      display: inline-block;
      margin-left: 15px;
    }

    .countdown {
      font-weight: bold;
      color: #e74c3c;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .config-button {
      margin: 0;
    }

    .value-only {
      display: none;
    }

    /* 弹窗样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ecf0f1;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 22px;
      color: #2c3e50;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 25px;
      border: none;
      width: 85%;
      max-width: 900px;
      border-radius: 12px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .close:hover,
    .close:focus {
      color: #e74c3c;
      transform: rotate(90deg);
    }

    .transfer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
    }

    .transfer-box {
      width: 45%;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .transfer-box h3 {
      margin-top: 0;
      text-align: center;
      font-size: 18px;
      color: #2c3e50;
      font-weight: 600;
    }

    .transfer-list {
      max-height: 300px;
      overflow-y: auto;
      min-height: 200px;
      background: white;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .transfer-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .transfer-item:hover {
      background: #e3f2fd;
    }

    .transfer-actions {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 10%;
    }

    .transfer-btn {
      margin: 5px 0;
      padding: 8px 15px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .transfer-btn:hover {
      background: linear-gradient(135deg, #2980b9, #3498db);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .transfer-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .filter-input {
      margin-bottom: 15px;
    }

    .filter-input input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 100%;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    .filter-input input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .selected-item {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      font-weight: 600;
    }

    /* 消息提示样式 */
    #modal-message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>币种跌幅榜</h1>

    <div class="header-row">
      <div>
        <a href="/" class="btn config-button"
          style="text-decoration: none; display: inline-block; line-height: normal;">
          返回首页
        </a>
        <button class="btn config-button" onclick="openCoinsConfig()" style="margin-left: 10px;">
          币种配置
        </button>
      </div>
      <div class="right-header-section">
        <div class="time-info">
          <div class="update-time-row">最后更新时间: <span id="last-update-time">--</span></div>
          <div class="countdown-row">下次刷新倒计时: <span id="countdown" class="countdown">--</span></div>
        </div>
        <button class="btn refresh-button" onclick="loadData(true)">
          <span>↻</span> 刷新
        </button>
      </div>
    </div>

    <!-- 删除了"数据每5分钟自动更新一次"这行 -->

    <div id="data-container">
      <div class="loading">正在获取最新数据...</div>
    </div>
  </div>

  <!-- 币种配置弹窗 -->
  <div id="coinsConfigModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>币种配置管理</h2>
        <span class="close">&times;</span>
      </div>
      <div id="modal-content">
        <div class="controls" style="margin-bottom: 20px; text-align: center">
          <button class="btn transfer-btn" onclick="updateFromBinanceModal()"
            style="padding: 10px 20px; margin: 0 10px">
            从币安更新币种
          </button>
        </div>

        <div class="transfer-container">
          <div class="transfer-box">
            <h3>所有币种</h3>
            <div class="filter-input">
              <input type="text" id="modalAllCoinsFilter" placeholder="搜索币种..." onkeyup="filterAllCoinsModal()" />
            </div>
            <div id="modalAllCoinsList" class="transfer-list">
              <div class="loading">加载中...</div>
            </div>
          </div>

          <div class="transfer-actions">
            <button class="transfer-btn" id="modalAddBtn" onclick="addToTrackedModal()" disabled>
              >>
            </button>
            <button class="transfer-btn" id="modalRemoveBtn" onclick="removeFromTrackedModal()" disabled>
              << </button>
          </div>

          <div class="transfer-box">
            <h3>跟踪的币种</h3>
            <div class="filter-input">
              <input type="text" id="modalTrackedCoinsFilter" placeholder="搜索币种..."
                onkeyup="filterTrackedCoinsModal()" />
            </div>
            <div id="modalTrackedCoinsList" class="transfer-list">
              <div class="loading">加载中...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let countdownInterval;
    let lastUpdateTime = 0;
    let allCoins = {}; // 存储所有币种及其跟踪状态
    let selectedAllCoins = new Set(); // 选中的所有币种
    let selectedTrackedCoins = new Set(); // 选中的跟踪币种

    // 页面加载完成后获取数据
    document.addEventListener("DOMContentLoaded", function () {
      loadData();
    });

    // 基于缓存更新时间计算倒计时
    function updateCountdownBasedOnCache() {
      const countdownElement = document.getElementById("countdown");

      // 计算下次刷新时间（下一个5分钟时间点）
      const now = new Date();
      const nextRefreshTime = new Date(lastUpdateTime);
      nextRefreshTime.setMinutes(
        Math.ceil(nextRefreshTime.getMinutes() / 5) * 5
      );
      nextRefreshTime.setSeconds(0);
      nextRefreshTime.setMilliseconds(0);

      // 如果计算出的时间已经过去，则加上5分钟
      if (nextRefreshTime <= now) {
        nextRefreshTime.setTime(nextRefreshTime.getTime() + 5 * 60 * 1000);
      }

      // 更新倒计时
      function updateCountdown() {
        const now = new Date();
        const timeDiff = nextRefreshTime - now;

        if (timeDiff <= 0) {
          // 时间到了，只获取最新数据而不强制更新
          loadCoinsData();
          // 重新计算下次刷新时间
          nextRefreshTime.setTime(nextRefreshTime.getTime() + 5 * 60 * 1000);
          return;
        }

        // 计算剩余时间
        const seconds = Math.floor(timeDiff / 1000);
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        countdownElement.textContent = `${minutes}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      // 立即更新一次
      updateCountdown();

      // 每秒更新倒计时
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    // 只获取币种数据，不触发更新
    function loadCoinsData() {
      const container = document.getElementById("data-container");

      // 获取跌幅榜数据
      fetch("/api/drop-list")
        .then((response) => {
          console.log("币种数据接口响应:", response);
          return response.json();
        })
        .then((result) => {
          console.log("币种数据结果:", result);
          if (result.status === "success") {
            console.log("数据获取成功，开始渲染数据...");

            // 只更新显示时间，不重启倒计时
            if (result.cache_update_time) {
              const lastUpdateElement = document.getElementById("last-update-time");
              const updateTime = new Date(result.cache_update_time);
              lastUpdateElement.textContent = updateTime.toLocaleString("zh-CN");
            }

            renderData(result.data);
          } else {
            console.log("数据获取失败:", result.message);
          }
        })
        .catch((error) => {
          console.error("加载数据时出错:", error);
        });
    }

    // 加载数据（包含更新和获取数据）
    function loadData(force = false) {
      const container = document.getElementById("data-container");
      const lastUpdateElement = document.getElementById("last-update-time");
      const countdownElement = document.getElementById("countdown");

      // 不再显示加载提示，保留现有数据展示
      // container.innerHTML = '<div class="loading">正在获取最新数据...</div>';

      // 先调用更新接口获取最新数据
      console.log("开始获取数据...");
      const url = "/api/drop-list";
      fetch(url)
        .then((response) => {
          console.log("更新接口响应:", response);
          return response.json();
        })
        .then((updateResult) => {
          console.log("更新结果:", updateResult);
          if (updateResult.status === "success") {
            // 更新成功后获取数据
            console.log("更新成功，开始获取币种数据...");
            return fetch("/api/coins");
          } else {
            // 更新失败时也尝试获取现有数据
            console.log("更新失败，但仍尝试获取币种数据...");
            return fetch("/api/drop-list");
          }
        })
        .then((response) => {
          console.log("币种数据接口响应:", response);
          return response.json();
        })
        .then((result) => {
          console.log("币种数据结果:", result);
          if (result.status === "success") {
            console.log("数据获取成功，开始渲染数据...");

            // 更新最后更新时间和倒计时
            if (result.cache_update_time) {
              updateLastUpdateTime(result.cache_update_time);
            }

            renderData(result.data);
          } else {
            console.log("数据获取失败:", result.message);
            // 只在确实失败时才显示错误信息
            // container.innerHTML = `<div class="error">加载失败: ${result.message}</div>`;
          }
        })
        .catch((error) => {
          console.error("加载数据时出错:", error);
          // 只在确实失败时才显示错误信息
          // container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
        });
    }

    // 更新最后更新时间和倒计时
    function updateLastUpdateTime(cacheUpdateTime) {
      const lastUpdateElement = document.getElementById("last-update-time");
      const countdownElement = document.getElementById("countdown");

      // 更新最后更新时间
      const updateTime = new Date(cacheUpdateTime);
      lastUpdateElement.textContent = updateTime.toLocaleString("zh-CN");
      lastUpdateTime = cacheUpdateTime;

      // 开始倒计时（基于缓存更新时间计算下次刷新时间）
      updateCountdownBasedOnCache();
    }

    // 更新倒计时显示（保持原有函数以兼容其他地方的调用）
    function updateCountdown(seconds) {
      const countdownElement = document.getElementById("countdown");
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      countdownElement.textContent = `${minutes}:${secs
        .toString()
        .padStart(2, "0")}`;
    }

    // 渲染数据
    function renderData(coinsData) {
      console.log("开始渲染跌幅榜数据:", coinsData);
      const container = document.getElementById("data-container");

      if (!coinsData || !Array.isArray(coinsData) || coinsData.length === 0) {
        console.log("无数据可渲染");
        container.innerHTML = '<div class="no-data">暂无数据</div>';
        return;
      }

      // 构建表格HTML - 简化的跌幅榜表格
      let html = `
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="padding-left: 20px; text-align: left;">排名</th>
                <th style="text-align: left;">币种</th>
                <th>当前价格 (USDT)</th>
                <th>24h 涨跌幅</th>
                <th>24h 成交金额 (USDT)</th>
              </tr>
            </thead>
            <tbody>
      `;

      // 添加数据行
      coinsData.forEach((coin, index) => {
        // 涨跌幅样式
        const changePercent = coin.price_change_percent;
        const changeClass = changePercent > 0 ? "positive" : changePercent < 0 ? "negative" : "";
        const changeSign = changePercent > 0 ? "+" : "";

        // 格式化成交额
        const quoteVolume = coin.quote_volume;
        let formattedVolume = "0";
        if (quoteVolume >= 100000000) {
          formattedVolume = (quoteVolume / 100000000).toFixed(2) + "亿";
        } else if (quoteVolume >= 10000) {
          formattedVolume = (quoteVolume / 10000).toFixed(2) + "万";
        } else {
          formattedVolume = parseFloat(quoteVolume).toFixed(2);
        }

        html += `
          <tr>
            <td style="padding-left: 20px; text-align: left; width: 60px;">
                <span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; background-color: ${index < 3 ? '#e74c3c' : '#bdc3c7'}; color: white; font-weight: bold; font-size: 12px;">
                    ${index + 1}
                </span>
            </td>
            <td style="text-align: left;">
                <strong><a href="/coin-detail?symbol=${coin.symbol}" style="color: #2c3e50; text-decoration: none;">${coin.symbol}</a></strong>
            </td>
            <td>
                <span style="font-weight: 600;">${parseFloat(coin.current_price).toFixed(coin.current_price < 1 ? 6 : 2)}</span>
            </td>
            <td>
                <span class="${changeClass}" style="font-weight: 600;">${changeSign}${parseFloat(changePercent).toFixed(2)}%</span>
            </td>
            <td>
                <span style="color: #7f8c8d;">${formattedVolume}</span>
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    // 打开币种配置弹窗
    function openCoinsConfig() {
      // 获取弹窗
      var modal = document.getElementById("coinsConfigModal");
      // 显示弹窗
      modal.style.display = "block";
      // 加载币种配置数据
      loadCoinsConfigModal();
    }

    // 获取币种配置（弹窗内）
    function loadCoinsConfigModal() {
      console.log("开始获取币种配置...");
      fetch("/api/coins-config")
        .then((response) => {
          console.log("API响应:", response);
          return response.json();
        })
        .then((data) => {
          console.log("返回数据:", data);
          if (data.status === "success") {
            console.log("数据获取成功:", data.data);
            allCoins = data.data;
            renderTransferListsModal(allCoins);
          } else {
            console.log("数据获取失败:", data.message);
            showMessageModal(data.message, "error");
          }
        })
        .catch((error) => {
          console.error("获取币种配置时出错:", error);
          showMessageModal("获取币种配置失败: " + error.message, "error");
        });
    }

    // 渲染穿梭框列表（弹窗内）
    function renderTransferListsModal(coins) {
      console.log("开始渲染穿梭框列表:", coins);
      const allCoinsList = document.getElementById("modalAllCoinsList");
      const trackedCoinsList = document.getElementById(
        "modalTrackedCoinsList"
      );

      // 检查容器元素是否存在
      if (!allCoinsList || !trackedCoinsList) {
        console.error("无法找到列表容器元素");
        return;
      }

      const coinEntries = Object.entries(coins);
      console.log("币种条目:", coinEntries);

      if (!coinEntries || coinEntries.length === 0) {
        console.log("无币种数据");
        allCoinsList.innerHTML = "<p>暂无币种配置</p>";
        trackedCoinsList.innerHTML = "<p>暂无币种配置</p>";
        return;
      }

      // 分离所有币种和跟踪币种
      const allCoinsArray = [];
      const trackedCoinsArray = [];

      coinEntries.forEach(([symbol, tracked]) => {
        allCoinsArray.push(symbol);
        if (tracked) {
          trackedCoinsArray.push(symbol);
        }
      });

      console.log("所有币种:", allCoinsArray);
      console.log("跟踪的币种:", trackedCoinsArray);

      // 渲染所有币种列表
      renderCoinListModal(allCoinsList, allCoinsArray, "all");

      // 渲染跟踪币种列表
      renderCoinListModal(trackedCoinsList, trackedCoinsArray, "tracked");

      // 更新按钮状态
      updateTransferButtonsModal();
    }

    // 渲染币种列表（弹窗内）
    function renderCoinListModal(container, coins, type) {
      console.log("渲染币种列表:", { container, coins, type });
      // 按字母顺序排序
      coins.sort();

      if (coins.length === 0) {
        container.innerHTML = "<p>暂无币种</p>";
        return;
      }

      let html = "";
      coins.forEach((symbol) => {
        const isSelected =
          type === "all"
            ? selectedAllCoins.has(symbol)
            : selectedTrackedCoins.has(symbol);
        html += `
                    <div class="transfer-item ${isSelected ? "selected-item" : ""
          }" 
                         data-symbol="${symbol}" 
                         onclick="toggleSelectionModal('${symbol}', '${type}')">
                        ${symbol}
                    </div>
                `;
      });

      container.innerHTML = html;
      console.log("列表渲染完成");
    }

    // 切换选中状态（弹窗内）
    function toggleSelectionModal(symbol, type) {
      const item = document.querySelector(
        `#coinsConfigModal .transfer-item[data-symbol="${symbol}"]`
      );

      if (type === "all") {
        if (selectedAllCoins.has(symbol)) {
          selectedAllCoins.delete(symbol);
          item.classList.remove("selected-item");
        } else {
          selectedAllCoins.add(symbol);
          item.classList.add("selected-item");
        }
      } else {
        if (selectedTrackedCoins.has(symbol)) {
          selectedTrackedCoins.delete(symbol);
          item.classList.remove("selected-item");
        } else {
          selectedTrackedCoins.add(symbol);
          item.classList.add("selected-item");
        }
      }

      updateTransferButtonsModal();
    }

    // 更新穿梭按钮状态（弹窗内）
    function updateTransferButtonsModal() {
      const addBtn = document.getElementById("modalAddBtn");
      const removeBtn = document.getElementById("modalRemoveBtn");

      if (addBtn) addBtn.disabled = selectedAllCoins.size === 0;
      if (removeBtn) removeBtn.disabled = selectedTrackedCoins.size === 0;
    }

    // 添加到跟踪列表（弹窗内）
    function addToTrackedModal() {
      if (selectedAllCoins.size === 0) return;

      // 批量更新选中的币种为跟踪状态
      const updates = Array.from(selectedAllCoins).map((symbol) => ({
        symbol: symbol,
        tracked: true,
      }));

      updateCoinsTrackingModal(updates, () => {
        // 清空选中状态
        selectedAllCoins.clear();
        // 重新加载列表
        loadCoinsConfigModal();
      });
    }

    // 从跟踪列表移除（弹窗内）
    function removeFromTrackedModal() {
      if (selectedTrackedCoins.size === 0) return;

      // 批量更新选中的币种为非跟踪状态
      const updates = Array.from(selectedTrackedCoins).map((symbol) => ({
        symbol: symbol,
        tracked: false,
      }));

      updateCoinsTrackingModal(updates, () => {
        // 清空选中状态
        selectedTrackedCoins.clear();
        // 重新加载列表
        loadCoinsConfigModal();
      });
    }

    // 更新币种跟踪状态（弹窗内）
    function updateCoinsTrackingModal(updates, callback) {
      let successCount = 0;
      let failCount = 0;

      Promise.all(
        updates.map((update) => {
          return fetch("/api/coins-config/track", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(update),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                successCount++;
                // 更新本地状态
                allCoins[update.symbol] = update.tracked;
              } else {
                failCount++;
              }
            })
            .catch((error) => {
              failCount++;
              console.error("Error updating", update.symbol, error);
            });
        })
      ).then(() => {
        if (failCount === 0) {
          showMessageModal(
            `成功更新 ${successCount} 个币种的跟踪状态`,
            "success"
          );
        } else {
          showMessageModal(
            `更新完成: ${successCount} 个成功, ${failCount} 个失败`,
            failCount > 0 ? "error" : "success"
          );
        }
        if (callback) callback();
      });
    }

    // 筛选所有币种（弹窗内）
    function filterAllCoinsModal() {
      const filterValue = document
        .getElementById("modalAllCoinsFilter")
        .value.toLowerCase();
      const items = document.querySelectorAll(
        "#modalAllCoinsList .transfer-item"
      );

      items.forEach((item) => {
        const symbol = item.getAttribute("data-symbol").toLowerCase();
        if (symbol.includes(filterValue)) {
          item.style.display = "";
        } else {
          item.style.display = "none";
        }
      });
    }

    // 筛选跟踪币种（弹窗内）
    function filterTrackedCoinsModal() {
      const filterValue = document
        .getElementById("modalTrackedCoinsFilter")
        .value.toLowerCase();
      const items = document.querySelectorAll(
        "#modalTrackedCoinsList .transfer-item"
      );

      items.forEach((item) => {
        const symbol = item.getAttribute("data-symbol").toLowerCase();
        if (symbol.includes(filterValue)) {
          item.style.display = "";
        } else {
          item.style.display = "none";
        }
      });
    }

    // 从币安更新币种配置（弹窗内）
    function updateFromBinanceModal() {
      if (
        !confirm(
          "确定要从币安获取最新币种列表吗？\n\n这将添加新上线的交易对到左侧列表（默认不跟踪），现有配置不受影响。"
        )
      ) {
        return;
      }

      showMessageModal("正在从币安获取最新币种列表...", "info");

      fetch("/api/coins-config/update-from-binance", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            showMessageModal(data.message || "币种配置更新成功", "success");
            loadCoinsConfigModal();
          } else {
            showMessageModal(data.message || "币种配置更新失败", "error");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showMessageModal(
            "更新币种配置时发生网络错误: " + error.message,
            "error"
          );
        });
    }

    // 显示消息（弹窗内）
    function showMessageModal(message, type) {
      // 创建或获取消息显示区域
      let messageContainer = document.getElementById("modal-message");
      if (!messageContainer) {
        // 创建消息容器
        messageContainer = document.createElement("div");
        messageContainer.id = "modal-message";
        messageContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
          `;
        document.body.appendChild(messageContainer);
      }

      // 设置消息内容和样式
      messageContainer.textContent = message;
      messageContainer.style.display = "block";

      // 根据消息类型设置背景色
      switch (type) {
        case "success":
          messageContainer.style.backgroundColor = "#28a745";
          break;
        case "error":
          messageContainer.style.backgroundColor = "#dc3545";
          break;
        case "info":
          messageContainer.style.backgroundColor = "#17a2b8";
          break;
        default:
          messageContainer.style.backgroundColor = "#6c757d";
      }

      // 3秒后自动隐藏消息
      setTimeout(() => {
        messageContainer.style.display = "none";
      }, 3000);
    }

    // 关闭弹窗
    window.addEventListener("click", function (event) {
      var modal = document.getElementById("coinsConfigModal");
      var span = document.querySelector("#coinsConfigModal .close");

      // 只有点击关闭按钮时才关闭弹窗，点击空白区域不关闭
      if (event.target == span) {
        modal.style.display = "none";
      }
    });
  </script>
</body>

</html>